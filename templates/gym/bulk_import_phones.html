{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-4-strong">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-file-upload me-2"></i>Bulk Import Phone Numbers</h5>
                </div>

                <div class="card-body">
                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>CSV File Format</h6>
                        <p class="mb-2">Your CSV file must have the following columns:</p>
                        <ul class="mb-2">
                            <li><strong>username</strong> - Member's username (must match existing member)</li>
                            <li><strong>phone_number</strong> - Phone number in international format (e.g., +1234567890)
                            </li>
                        </ul>
                        <p class="mb-0"><small>Download <a href="#" id="downloadTemplate" class="alert-link">sample
                                    template</a></small></p>
                    </div>

                    <form method="post" enctype="multipart/form-data" id="importForm">
                        {% csrf_token %}

                        <div class="mb-4">
                            <label for="{{ form.csv_file.id_for_label }}" class="form-label fw-bold">
                                {{ form.csv_file.label }}
                            </label>
                            {{ form.csv_file }}
                            <div class="form-text">{{ form.csv_file.help_text }}</div>
                            {% if form.csv_file.errors %}
                            <div class="text-danger mt-2">{{ form.csv_file.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Phone numbers must be in international format starting with +</li>
                                <li>Example: +1234567890 (not 1234567890 or (123) 456-7890)</li>
                                <li>Existing phone numbers will be overwritten</li>
                                <li>Maximum file size: 5MB</li>
                            </ul>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'member_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload me-2"></i>Import Phone Numbers
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Instructions Card -->
            <div class="card shadow-4-strong mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-question-circle me-2 text-info"></i>How to Use</h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">
                            <strong>Prepare your CSV file</strong>
                            <ul>
                                <li>Create a CSV file with columns: username, phone_number</li>
                                <li>Ensure usernames match existing members in the system</li>
                                <li>Format all phone numbers with country code (e.g., +1 for USA)</li>
                            </ul>
                        </li>
                        <li class="mb-2">
                            <strong>Upload the file</strong>
                            <ul>
                                <li>Click "Choose File" and select your CSV</li>
                                <li>Click "Import Phone Numbers"</li>
                            </ul>
                        </li>
                        <li class="mb-2">
                            <strong>Review results</strong>
                            <ul>
                                <li>Success message shows how many numbers were imported</li>
                                <li>Error messages show which rows had issues</li>
                                <li>Fix errors and re-upload if needed</li>
                            </ul>
                        </li>
                    </ol>
                </div>
            </div>

            <!-- Example Card -->
            <div class="card shadow-4-strong mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-file-csv me-2 text-success"></i>Example CSV Content</h6>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded"><code>username,phone_number
john_doe,+12025551234
jane_smith,+14155559876
mike_wilson,+13105551111</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Generate and download sample CSV template
    document.getElementById('downloadTemplate').addEventListener('click', function (e) {
        e.preventDefault();

        const csvContent = "username,phone_number\njohn_doe,+12025551234\njane_smith,+14155559876";
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'phone_import_template.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    });

    // File validation
    document.getElementById('importForm').addEventListener('submit', function (e) {
        const fileInput = document.querySelector('input[type="file"]');

        if (!fileInput.files.length) {
            e.preventDefault();
            alert('Please select a CSV file to upload');
            return false;
        }

        const file = fileInput.files[0];
        if (!file.name.endsWith('.csv')) {
            e.preventDefault();
            alert('Please upload a CSV file (.csv)');
            return false;
        }

        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Importing...';
    });
</script>
{% endblock %}
